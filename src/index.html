<!DOCTYPE html>
<html> 
    <head>
        <meta charset="utf-8">
        <title>Chord Information Calculator</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
        <script data-main = "chords.js" src = "require.js"></script>
        <style>
            .white-key {
              width: 80px;
              height: 200px;
              background-color: white;
              border: 2px solid black;
              float: left;
              position: relative;
              margin-right: -1px;
              display: flex;
              justify-content:center;
              align-items: end;
              color:black;
              z-index: 0;
              vertical-align: text-bottom;
            }
            
            .black-key {
              width: 40px;
              height: 140px;
              background-color: black;
              border: 4px solid black;
              position: absolute;
              top: 0px;
              float: left;
              display: flex;
              justify-content:center;
              align-items: center;
              z-index: 2;
              left:0px;
            }
      
            .pressed {
              background-color: rgb(255, 123, 0);
            }

            #piano-container {
                display: none;
                position: relative;
            }
          </style>
        
    </head>
    <body>
        
        <h1>Pitch class set information calculator</h1>
        <p>Input your pitch collection in the textbox below using integer notation or capitalized letter names <strong>separated by spaces.</strong></p>
        <small>Note: for letter names, format your notes using b for flat, bb for double flat, # for sharp, and x for double sharp notes.</small>
        <br><br>
        <form>
            <label for="input">Input:</label>
            <br>
            <input type="text" id="input" name="input" onchange="updatePiano()" size = "30">
            <br>
            <div id="piano-container">
              <div class="white-key" note-name="C" note-int="0">0</div>
              <div class="black-key" note-name="C#" note-int="1" style="left: 60px">1</div>
              <div class="white-key" note-name="D" note-int="2">2</div>
              <div class="black-key" note-name="D#" note-int="3" style="left: 144px">3</div>
              <div class="white-key" note-name="E" note-int="4">4</div>
              <div class="white-key" note-name="F" note-int="5">5</div>
              <div class="black-key" note-name="F#" note-int="6" style="left: 308px">6</div>
              <div class="white-key" note-name="G" note-int="7">7</div>
              <div class="black-key" note-name="G#" note-int="8"style="left: 392px">8</div>
              <div class="white-key" note-name="A" note-int="9">9</div>
              <div class="black-key" note-name="A#" note-int="10"style="left: 476px">10</div>
              <div class="white-key" note-name="B" note-int="11">11</div>
            </div>
            <br><br><br><br><br><br><br><br><br><br>
            <input type="submit" value="Submit">
        </form>
        <script>
          //int notation regex: /^\s*([0-9]?(10)?(11)?)(?:\s+([0-9]?(10)?(11)?))*\s*$/g
          //letter notation regex: /^\s*([A-G](b)?(bb)?(#)?(x)?)(?:\s+([A-G](b)?(bb)?(#)?(x)?))*\s*$/g
          //Final pattern: /^\s*([A-G](b)?(bb)?(#)?(x)?)(?:\s+([A-G](b)?(bb)?(#)?(x)?))*\s*$|^\s*([0-9]?(10)?(11)?)(?:\s+([0-9]?(10)?(11)?))*\s*$/g
            const Piano = {
              keys: null,
              initialize: function() {
                this.keys = document.querySelectorAll('.white-key, .black-key');
                this.keys.forEach(key => {                  
                  key.isPressed = false;
                  key.addEventListener('click', (event) => {
                    event.preventDefault();
                    key.isPressed = !key.isPressed;
                    key.classList.toggle('pressed', key.isPressed);
                    updateInput();
                  });
                });
              },
              show: function() {
                document.getElementById('piano-container').style.display = 'block';
              },
              hide: function(){
                document.getElementById("piano-container").style.display = 'none';
              }
            }

            Piano.initialize();
            Piano.show();

            const Input = document.getElementById("input");
            
            function inputIsIntNotation(input){
              return input.match(/^\s*([0-9]?(10)?(11)?)(?:\s+([0-9]?(10)?(11)?))*\s*$/g);
            }

            function inputIsLetterNotation(input){
              return input.match(/^\s*([A-G](b)?(bb)?(#)?(x)?)(?:\s+([A-G](b)?(bb)?(#)?(x)?))*\s*$/g);
            }

            function updateInput(){
              if(Input.value.length==0 || inputIsIntNotation(Input.value)){
                updateInputInts();
              } else if(inputIsLetterNotation(Input.value)){
                updateInputLetters();
              } else {
                Input.value=""
              }
            }

            function updateInputInts(){
              let pressedKeys = document.querySelectorAll(".pressed");
              let pressedKeysArray = Array.from(pressedKeys);
              let pressedKeysInts = pressedKeysArray.map(key => key.getAttribute("note-int"));
              Input.value = pressedKeysInts.join(" ");
            }

            function updateInputLetters(){
              let pressedKeys = document.querySelectorAll(".pressed");
              let pressedKeysArray = Array.from(pressedKeys);
              let pressedKeysLetters = pressedKeysArray.map(key => key.getAttribute("note-name"));
              Input.value = pressedKeysLetters.join(" ");
            }

            function updatePiano(){
              let input = Input.value.trim();
              if(input.length>=1){
                if(inputIsLetterNotation(input)){
                  updatePianoLetterNotation(input);
                } else if(inputIsIntNotation(input)){
                  updatePianoIntNotation(input);
                } else {
                  Input.value=""
                  updatePianoFromInts([]);
                }
              } else {
                updatePianoFromInts([]);
              }
            } 

            function updatePianoIntNotation(input){
              updatePianoFromInts(input.split(" ").map(key => parseInt(key)));
              Input.value = removeDuplicateInts(input);
            }

            function updatePianoLetterNotation(input){
              let classes = input.split(" ").map(key => PitchClass.classFromPitchName(key))
              updatePianoFromInts(classes.map(key => key.getPitchClass()));
              Input.value = removeDuplicateLetters(input);
            }

            function updatePianoFromInts(ints){
              console.log(ints);  
              Piano.keys.forEach(key => {
                let keyInt = parseInt(key.getAttribute("note-int"));
                if(ints.includes(keyInt)){
                  key.isPressed=true;
                } else {
                  key.isPressed=false;
                }
                key.classList.toggle('pressed', key.isPressed);
              });
            }

            function removeDuplicateInts(str){
              let inputInts = str.split(" ").map(key => parseInt(key));
              return  [...new Set(inputInts)].join(" ");
            }

            function removeDuplicateLetters(str){
              return  [...new Set(str.split(" "))].join(" ");
            }

            //replaces 10 and 11 with t and e
            function intToTe(n){
              if(n==10){
                return "t";
              } else if(n==11){
                return "e";
              } else {
                return n;
              }
            }

            function calculate(){
              console.log(Input);
            }
          </script>
    </body>
</html>
